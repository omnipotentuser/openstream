function Conference(){console.log("conference ready");var e=(new ConferenceViews,null);this.leave=function(n,o){e&&(e.leave(),e=null),n(o)}}function ConferenceViews(){}function trace(e){"\n"==e[e.length-1]&&(e=e.substring(0,e.length-1)),console.log((performance.now()/1e3).toFixed(3)+": "+e)}function logError(e){console.log("error: "+e.name)}function Peer(e,n,o,t){var a=null,r=n,i=null,s=null,l=e,c=null,d=o,u={iceServers:[]},f=[];f=t.length>0?t:navigator.mozGetUserMedia?[{url:"stun:stun.vline.com"}]:[{url:"stun:stun.1.google.com:19302"},{url:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"}],this.getid=function(){return r},this.hasPC=function(){return a?!0:!1},this.close=function(){a&&a.close(),s&&s.close()},this.buildClient=function(e,n,o){for(var t=0;t<f.length;t++){var r={};r=createIceServer(f[t].url,f[t].username,f[t].credential),u.iceServers.push(r)}a=new RTCPeerConnection(u),a.onaddstream=h,a.onicecandidate=y,a.oniceconnectionstatechange=w,a.onnegotiationneeded=b,a.onremovestream=S,a.onsignalingstatechange=J,"offer"===o?(s=a.createDataChannel("chat".dataChannelOptions),s.onerror=g,s.onmessage=p,s.onopen=v,s.onclose=m,console.log("readyState",s.readyState)):(a.ondatachannel=k,console.log("DataChannel - listening")),i=n,e?(c=e,a.addStream(c)):alert("Media device is not detected.")};var g=function(e){console.log("data channel error:",e)},p=function(e){if(i&&r){var n={from_id:r,code:e.data};i(n)}},v=function(){console.log("the data channel is opened")},m=function(){console.log("the data channel is closed")},h=function(e){console.log("onAddStream "+e.stream.id),$("#"+r).attr("src",window.URL.createObjectURL(e.stream))},y=function(e){if(e.candidate){var n={room:d,candidate:e.candidate,to_id:r};l.emit("candidate",n)}},w=function(){console.log("onIceConnectionStateChange state: "+a.iceConnectionState)},b=function(){console.log("onNegotiationNeeded")},S=function(e){console.log("onRemoveStream "+e)},J=function(){console.log("onSignalingStateChange: "+a.signalingState)};this.addIceCandidate=function(e){a?a.addIceCandidate(new RTCIceCandidate(e)):console.log("No peer candidate instance")};var C=function(e){"closed"!==a.signalingState&&a.setLocalDescription(e,function(){var e={room:d,sdp:a.localDescription,to_id:r};l.emit("sdp",e)},logError)},k=function(e){s&&"closed"!==s.readyState?console.log("dataChannel channel already created"):(s=e.channel,s.onmessage=p,s.onopen=v,s.onclose=m,console.log("DataChannel remote connection status",s.readyState))};this.peerCreateOffer=function(){console.log("peerCreateOffer called"),a.createOffer(C,logError)},this.setRemoteDescription=function(e){console.log("setRemoteDescription signalingState "+a.signalingState),a.setRemoteDescription(new RTCSessionDescription(e),function(){"offer"===a.remoteDescription.type&&(console.log("createAnswer to remote sdp offer"),a.createAnswer(C,logError))},logError)},this.sendData=function(e){s&&"open"===s.readyState.toLowerCase()?s.send(e):console.log("DataChannel not ready")}}function RTCEngine(){function e(){var e={video:{mandatory:{}},audio:!0};getUserMedia(e,function(e){w=e;var n=$("#local-video");n.attr("src",window.URL.createObjectURL(w)),w.onloadedmetadata=function(e){console.log("onloadedmetadata called, properties:");for(var n in e)console.log(n+" in "+e[n])},console.log("joining",y),h.emit("join",{room:y})},logError)}function n(){for(w&&w.stop();v.length>0;)m=v.pop(),m.close();h&&h.emit("exit")}function o(e,n){if(y){var o={room:y,code:e};if(n)h.emit("byteChar",o);else for(var t=0;t<v.length;t++)v[t].sendData(e)}}function t(e,n){if(y){var o={room:y,code:e};if(n)h.emit("byteChar",o);else for(var t=0;t<v.length;t++)v[t].sendData(e)}}function a(e,n){"undefined"==typeof n&&(n=function(){}),e.on("id",function(e){b=e.yourId,console.log("localId: "+b),n("id",{id:b})})}function r(e,n){"undefined"==typeof n&&(n=function(){}),e.on("createPeers",function(e){console.log("socket received createPeers signal");var o=e.users;o.length>0&&i(o,n)})}function i(e,n){var o=e.shift();n("create",{id:o});var t=new Peer(h,o,y,S);t.buildClient(w,f,"answer"),v.push(t),e.length>0&&i(e,n)}function s(e,n){"undefined"==typeof n&&(n=function(){}),e.on("createOffer",function(o){var t=new Peer(e,o.id,y,S);t.buildClient(w,f,"offer"),v.push(t),n("create",{id:o.id}),t.peerCreateOffer()})}function l(e){e.on("candidate",function(e){for(var n=0;n<v.length;n++)v[n].getid()===e.from_id&&(v[n].hasPC()||(console.log("ICE Candidate received: PC not ready. Building."),v[n].buildClient(w,f,"answer")),v[n].addIceCandidate(e.candidate))})}function c(e){e.on("sdp",function(e){console.log("sdp offer received");for(var n=0;n<v.length;n++)v[n].getid()===e.from_id&&(v[n].hasPC()||(console.log("SDP received: PC not ready. Building."),v[n].buildClient(w,f,"answer")),v[n].setRemoteDescription(e.sdp))})}function d(e,n){"undefined"==typeof n&&(n=function(){}),e.on("leave",function(e){console.log("handleClientDisconnected",e);for(var o=0;o<v.length;o++)if(v[o].getid()===e&&v[o].hasPC())return v.splice(o,1),void n("peerDisconnect",{id:e})})}function u(e,n){"undefined"==typeof n&&(n=function(){}),e.on("error",function(e){var o;switch(console.log("handleSysCode",e),e.error){case"room full":o="Room is full";break;default:o="Unknown Error"}n("error",{msg:o})}),e.on("info",function(e){var o;switch(e.info){case"room empty":o="Room is empty";break;default:o="Unknown Error"}n("info",{msg:o})})}function f(e){for(var n=0;n<v.length;n++)if(v[n].getid()===e.from_id)return v[n].hasPC()?J("readbytechar",e):console.log("Message received: PC not ready."),{}}function g(e,n){"undefined"==typeof n&&(n=function(){}),e.on("byteChar",function(e){for(var o=0;o<v.length;o++)if(v[o].getid()===e.from_id)return v[o].hasPC()?n("readbytechar",e):console.log("Message received: PC not ready."),{}})}function p(e){e.length>0&&(S=e)}var v=[],m=null,h=null,y=null,w=null,b=null,S=[],J=function(){},C=function(e,n){y=e,J=n,h=io("/",{forceNew:!0}),console.log("socket connecting"),h.on("connect",function(){a(h,n),r(h,n),s(h,n),l(h),c(h),g(h,n),d(h,n),u(h,n),n("connected")})};return{updateIce:p,connect:C,join:e,leave:n,sendChar:o,sendString:t}}function Hallway(){var e=new RTCEngine,n=new HallwayViews,o=null,t="",a=$("#roomnameinput"),r=$("#joinroombtn"),i=$("#randomgeneratorbtn");$.post("https://api.xirsys.com/getIceServers",{ident:"openhack",secret:"03150bbb-a1e7-49ff-862b-ab28688111a3",domain:"www.openhack.net",application:"default",room:"default",secure:"1"},function(n,o){var t=JSON.parse(n);"success"===o&&(console.log("post success"),e.updateIce(t.d.iceServers))});var s=function(t,a){if(t){var r="";switch(t){case"connected":console.log("rtc engine connected"),e.join();break;case"id":o=a.id;break;case"create":r=a.id,console.log("creating new media element",r),n.appendPeerMedia(r);break;case"peerDisconnect":r=a.id,n.deletePeerMedia(a.id);break;case"readbytechar":n.updateTextArea(a.from_id,a.code);break;case"info":console.log(a.msg);break;case"error":console.log(a.msg)}}},l=function(o){""===t&&(t=a.val()),""===t?alert("Cannot have empty name"):(o.preventDefault(),n.openMediaViews(),function(e,n){console.log("starting rtc engine"),n.connect(e,s)}(t,e),n.updateTitle(t),window.history.replaceState({},"OpenStream "+t,"#"+t),r.unbind("click",l),i.unbind("click",u))};this.leave=function(o,t){a.val(""),r.unbind("click",l),i.unbind("click",u),e.leave(),n.closeMediaViews(o,t),n=null,e=null};var c=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},d=function(){return c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c()},u=function(){a.val(d()),r.trigger("click")};r.bind("click",l),i.bind("click",u),n.setListeners(e),function(){var e=window.location.hash,n=e.lastIndexOf("#");-1!==n&&(e=e.substring(n+1)),t=-1===n?"":e.length>0?e:"",console.log("roomName",t),""!==t&&r.trigger("click")}()}function HallwayViews(){var e=!1,n={192:"126",49:"33",50:"64",51:"35",52:"36",53:"37",54:"94",55:"38",56:"42",57:"40",48:"41",189:"95",187:"43",219:"123",221:"125",220:"124",186:"58",222:"34",188:"60",190:"62",191:"63"},o={8:"8",13:"13",32:"32",186:"58",187:"61",188:"44",189:"45",190:"46",191:"47",192:"96",219:"91",220:"92",221:"93",222:"39"},t=function(n){n.preventDefault();var o=$("#local-ta");$(".hallway-input-checkbox-wsmode").is(":checked")?(o.val(o.val()+"\nDataChannel disabled, using WebSocket instead.\n"),e=!0):(o.val(o.val()+"\nDataChannel enabled.\n"),e=!1)},a=function(){var e=$("<div/>",{"class":"hallway-layout-options"}).append('<input type="text" class="hallway-input-text-clip" placeholder="Paste from clipboard"/>').append('<button class="hallway-btn-clip" title="Send to peers" type="submit"> send </button>'),n=$("<div/>",{"class":"hallway-layout-options"}).append('<input type="checkbox" class="hallway-input-checkbox-wsmode" value="enable">Use WebSocket</input>');$("<div/>",{id:"local-container","class":"media-layout"}).append('<video id="local-video" autoplay controls muted>').append(e).append(n).append('<textarea id="local-ta" placeholder="Being typing in real time"></textarea>').appendTo("#hallway-video-container");var o=$("#roomnameinput");o.focus(),o.keypress(function(e){13===e.which&&(e.preventDefault(),$("#joinroombtn").trigger("click"))}),$(".hallway-input-checkbox-wsmode").bind("change",t)};this.setListeners=function(t){$("#local-ta").on("keydown",function(a){var r=t.sendChar,i=a.keyCode?a.keyCode:a.which;return"37"===i||"38"===i||"39"===i||"40"===i?void a.preventDefault():void(16!==i&&(i>=65&&90>=i?(a.shiftKey||(i+=32),r(i,e)):a.shiftKey&&void 0!==n[i]?(i=n[i],r(i,e)):void 0!==o[i]?(i=o[i],r(i,e)):i>=48&&57>=i?r(i,e):console.log("keycode not accepted")))}),$(".hallway-btn-clip").on("click",function(){var n=t.sendString,o=$(".hallway-input-text-clip"),a=o.val();a&&a.length<4?alert("Word is too short. Must be at least 4 characters long."):a&&(n(a,e),o.val(""))})},this.destroyListeners=function(){$(".hallway-input-checkbox-wsmode").unbind("change",t)},this.openMediaViews=function(){$("#hallway-room-input").css("display","none"),$("#hallway-video-container").css("display","inline-block")},this.closeMediaViews=function(e,n){$("#hallway-room-title").empty(),$("#hallway-video-container").fadeOut(function(){$("#hallway-room-input").fadeIn(200,function(){e(n)})}),this.destroyListeners(),this.deleteAllMedia()},this.appendPeerMedia=function(e){console.log("appendPeerMedia",e);var n=$("<div/>",{"class":"hallway-layout-options"}).append('<label class="hallway-label-bitrate">Bitrate: Not implemented yet.</label>');$("<div/>",{"class":"media-layout"}).append('<video id="'+e+'" autoplay controls>').append(n).append('<div class="hallway-layout-options"/>').append('<textarea id="'+e+'-ta" class="remote-textarea" readonly></textarea>').appendTo("#hallway-video-container");var o=$(".media-layout"),t=100/o.length;o.css("width",t+"%")},this.deletePeerMedia=function(e){$("#"+e).parent().remove();var n=$(".media-layout"),o=100/n.length;n.css("width",o+"%"),console.log("deletePeerMedia",e)},this.deleteAllMedia=function(){$("#hallway-video-container").empty()},this.updateTextArea=function(e,n){var o=$("#"+e+"-ta");if(n.length>3)o.val(o.val()+"\n"+n+"\n");else if("8"===n)o.val(o.val().slice(0,-1));else{var t=String.fromCharCode(n);o.val(o.val()+t)}o.scrollTop(o[0].scrollHeight)},this.updateTitle=function(e){$("#hallway-room-title").append("<p>Room: "+e+"</p>")},a()}function Lavatory(){console.log("lavatory ready");var e=new LavatoryViews;$(".lavatory-engage").bind("click",e.start),this.leave=function(n,o){e&&(e.stop(),$(".lavatory-engage").unbind("click",e.start)),n(o)}}function LavatoryViews(){function e(){u?h():(a.removeClass("lifted").addClass("pressed").html("stop"),n(),u=!0)}function n(){Janus.init({debug:!0,callback:function(){Janus.isWebrtcSupported()&&(c=new Janus({server:m,success:function(){c.attach({plugin:"janus.plugin.echotest",success:function(e){$("#details").remove(),l.css("display","inline-block"),d=e,console.log("Plugin attached! ("+d.getPlugin()+", id="+d.getId()+")");var n={audio:!0,video:!0};console.log("Sending message ("+JSON.stringify(n)+")"),d.send({message:n}),console.log("Trying a createOffer too (audio/video sendrecv)"),d.createOffer({media:{data:!0},success:function(e){console.log("Got SDP!"),console.log(e),d.send({message:n,jsep:e})},error:function(e){console.log("WebRTC error:"),console.log(e)}})},error:function(e){console.log("  -- Error attaching plugin... "+e)},consentDialog:function(){},onmessage:function(e,n){console.log(" ::: Got a message :::"),console.log(JSON.stringify(e)),void 0!==n&&null!==n&&(console.log("Handling SDP as well..."),console.log(n),d.handleRemoteJsep({jsep:n}));var o=e.result;null!==o&&void 0!==o&&"done"===o&&($("#lavatory-myvideo").remove(),$("#lavatory-peervideo").remove(),$("#lavatory-label-curbitrate").hide())},onlocalstream:function(e){console.log(" ::: Got a local stream :::"),console.log(JSON.stringify(e)),0===$("#lavatory-myvideo").length&&$("#lavatory-video-local").append('<video class="rounded centered" id="lavatory-myvideo" width=320 height=240 autoplay muted="muted"/>'),attachMediaStream($("#lavatory-myvideo").get(0),e),$("#lavatory-myvideo").get(0).muted="muted"},onremotestream:function(e){console.log(" ::: Got a remote stream :::"),console.log(JSON.stringify(e)),0===$("#lavatory-peervideo").length&&($("#lavatory-video-remote").append('<video class="rounded centered" id="lavatory-peervideo" width=320 height=240 autoplay/>'),$("#lavatory-peervideo").bind("loadedmetadata",function(){if("chrome"===webrtcDetectedBrowser){var e=this.videoWidth,n=this.videoHeight;$("#lavatory-label-resolution").text(e+" x "+n)}else setTimeout(function(){var e=$("#lavatory-peervideo").get(0).videoWidth,n=$("#lavatory-peervideo").get(0).videoHeight;$("#lavatory-label-resolution").text(e+" x "+n).show()},2e3)})),attachMediaStream($("#lavatory-peervideo").get(0),e),g=!0,p=!0,i.bind("click",function(){g=!g,g?(console.log("\n\nNICK audio pressed \n\n"),i.removeClass("lifted").addClass("pressed"),i.html("Audio Enabled")):(console.log("\n\nNICK audio lifted \n\n"),i.removeClass("pressed").addClass("lifted"),i.html("Audio Disabled")),d.send({message:{audio:g}})}),s.bind("click",function(){p=!p,p?(s.removeClass("lifted").addClass("pressed"),s.html("Video Enabled")):(s.removeClass("pressed").addClass("lifted"),s.html("Video Disabled")),d.send({message:{video:p}})}),r.bind("click",function(e){e.preventDefault(),v=!v,v?t.css("display","block"):t.css("display","none")}),o.bind("click",function(e){e.preventDefault();var n=$(this).attr("id"),o=1e3*parseInt(n);return console.log(0===o?"Not limiting bandwidth via REMB":"Capping bandwidth to "+o+" via REMB"),d.send({message:{bitrate:o}}),!1}),"chrome"===webrtcDetectedBrowser&&($("#lavatory-label-curbitrate").removeClass("hide").show(),f=setInterval(function(){var e=d.getBitrate();$("#lavatory-label-curbitrate").text(e)},1e3))},ondataopen:function(){console.log("The DataChannel is available!")},ondata:function(e){console.log("We got data from the DataChannel! "+e),$("#lavatory-input-datarecv").val(e)},oncleanup:function(){console.log(" ::: Got a cleanup notification :::"),$("#lavatory-myvideo").remove(),$("#lavatory-peervideo").remove(),$("#lavatory-label-curbitrate").hide()}})},error:function(n){console.log(n),alert(n,function(){e()})},destroyed:function(){e()}}))}})}var o=$("#lavatory-dropdown-bitrate a"),t=$(".lavatory-dropdown-menu"),a=$(".lavatory-engage"),r=$("#lavatory-btn-bitrate"),i=$("#lavatory-toggle-audio"),s=$("#lavatory-toggle-video"),l=$(".lavatory-container-location"),c=null,d=null,u=!1,f=null,g=!1,p=!1,v=!1,m="/janus/";console.log("creating LavatoryViews");var h=function(){c&&(clearInterval(f),c.destroy(),c=null,d=null,u=!1,f=null,g=!1,p=!1,v=!1),l.css("display","none"),a.removeClass("pressed").addClass("lifted").html("start"),i.removeClass("lifted").addClass("pressed"),i.html("Audio Enabled"),i.unbind("click"),s.removeClass("lifted").addClass("pressed"),s.html("Video Enabled"),s.unbind("click"),r.unbind("click"),o.unbind("click"),t.css("display","none")};return{stop:h,start:e}}function checkEnter(e){var n=e.keyCode?e.keyCode:e.which?e.which:e.charCode;return 13===n?(sendData(),!1):!0}function sendData(){var e=$("#lavatory-input-datasend").val();return""===e?void alert("Insert a message to send on the DataChannel"):void echotest.data({text:e,error:function(e){alert(e)},success:function(){$("#lavatory-input-datasend").val("")}})}function Lobby(e){console.log("lobby ready");var n=new LobbyViews(e);return n.pages}function LobbyViews(e){var n=1024,o=$("body"),t=$("#lobby-banner");window.addEventListener("resize",function(){var e=window.innerWidth;n>e?(o.css("left",0),o.css("right",0),t.css("right",0)):(o.css("left",200),o.css("right",200),t.css("right",-150))},!0),$(document).ready(function(){window.dispatchEvent(new Event("resize"))});var a=$("#lobby-banner"),r=($("#lavatory-link"),$("#conference-link"),$("#lounge-link"),$("#stage-link"),$("#hallway-link"),$("#modular-link"),$("#lobby-main")),i=r,s=function(){a.fadeOut(),i.fadeOut(function(){r.fadeIn()}),i=r,e("lobby")},l=function(){i=$("#conference-main"),r.fadeOut(function(){i.fadeIn(),a.fadeIn()}),e("conference")},c=function(){i=$("#lavatory-main"),r.fadeOut(function(){i.fadeIn(),a.fadeIn()}),e("lavatory")},d=function(){i=$("#lounge-main"),r.fadeOut(function(){i.fadeIn(),a.fadeIn()}),e("lounge")},u=function(){i=$("#stage-main"),r.fadeOut(function(){i.fadeIn(),a.fadeIn()}),e("stage")},f=function(){i=$("#modular-main"),r.fadeOut(function(){i.fadeIn(),a.fadeIn()}),e("modular")},g=function(){i=$("#hallway-main"),r.fadeOut(function(){i.fadeIn(function(){$("#roomnameinput").focus()}),a.fadeIn()}),e("hallway")},p={lavatory:c,conference:l,lounge:d,lobby:s,stage:u,modular:f,hallway:g};return{pages:p}}function Lounge(){var e=new RTCEngine,n=new LoungeViews,o=null,t="",a=$("#lounge-input-roomname"),r=$("#lounge-btn-create"),i=function(t,a){if(t){var r="";switch(t){case"connected":console.log("rtc engine connected"),e.join();break;case"id":o=a.id;break;case"create":r=a.id,console.log("creating new media element",r),n.appendPeerMedia(r);break;case"peerDisconnect":r=a.id,n.deletePeerMedia(a.id);break;case"readbytechar":n.updateTextArea(a.from_id,a.code);break;case"info":console.log(a.msg);break;case"error":console.log(a.msg)}}},s=function(o){""===t&&(t=a.val()),""===t?alert("Cannot have empty name"):(o.preventDefault(),n.openMediaViews(),function(e,n){console.log("starting rtc engine"),n.connect(e,i)}(t,e),n.updateTitle(t),window.history.replaceState({},"OpenStream "+t,"#"+t),r.unbind("click",s))};this.leave=function(o,t){a.val(""),r.unbind("click",s),e&&(e.leave(),e=null),n&&(n.closeMediaViews(o,t),n=null),console.log("Lounge exiting")},r.bind("click",s),n.setListeners(e),function(){var e=window.location.hash,n=e.lastIndexOf("#");-1!=n&&(e=e.substring(n+1)),t=-1==n?"":e.length>0?e:"",console.log("roomName",t),""!==t&&joinRoomBtn.trigger("click")}()}function LoungeViews(){var e=function(){$("<div/>",{id:"local-container","class":"media-layout"}).append('<video id="local-video" autoplay controls muted>').appendTo("#video-container");var e=$("#lounge-input-roomname");e.focus(),e.keypress(function(e){13===e.which&&(e.preventDefault(),$("#lounge-btn-create").trigger("click"))})};this.setListeners=function(){},this.openMediaViews=function(){$("#room-input").css("display","none"),$("#video-container").css("display","inline-block")},this.closeMediaViews=function(e,n){$("#lounge-room-title").empty(),$("#video-container").fadeOut(function(){this.deleteAllMedia()}),e(n)},this.appendPeerMedia=function(e){console.log("appendPeerMedia",e),$("<div/>",{"class":"media-layout"}).append('<video id="'+e+'" autoplay controls>').appendTo("#video-container");var n=$(".media-layout"),o=100/n.length;n.css("width",o+"%")},this.deletePeerMedia=function(e){$("#"+e).parent().remove();var n=$(".media-layout"),o=100/n.length;n.css("width",o+"%"),console.log("deletePeerMedia",e)},this.deleteAllMedia=function(){$("#video-container").empty()},this.updateTitle=function(e){$("#lounge-room-title").append("<p>Room: "+e+"</p>")},e()}function Modular(){console.log("modular ready");var e=(new ModularViews,null);this.leave=function(n,o){e&&(e.leave(),e=null),n(o)}}function ModularViews(){}function Stage(){console.log("stage ready");var e=(new StageViews,null);this.leave=function(n,o){e&&(e.leave(),e=null),n(o)}}function StageViews(){}function Janus(e){function n(e){charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var n="",o=0;e>o;o++){var t=Math.floor(Math.random()*charSet.length);n+=charSet.substring(t,t+1)}return n}function o(){if(null!=L){if(Janus.log("Long poll..."),!A)return void Janus.log("Is the gateway down? (connected=false)");var n=x+"/"+L+"?rid="+(new Date).getTime();void 0!==E&&null!==E&&(n=n+"&maxev="+E),$.ajax({type:"GET",url:n,cache:!1,timeout:6e4,success:t,error:function(n,t,a){return Janus.log(t+": "+a),Q++,Q>3?(A=!1,void e.error("Lost connection to the gateway (is it down?)")):void o()},dataType:"json"})}}function t(e){if(Q=0,O||void 0===L||null===L||setTimeout(o,200),Janus.log("Got event on session "+L),Janus.log(e),O||!$.isArray(e)){if("keepalive"!==e.janus&&"ack"!==e.janus)if("success"!==e.janus){if("webrtcup"!==e.janus)if("hangup"===e.janus){var n=e.sender;if(void 0===n||null===n)return void Janus.log("Missing sender...");var a=N[n];if(void 0===a||null===a)return void Janus.log("This handle is not attached to this session");a.hangup()}else if("detached"===e.janus){var n=e.sender;if(void 0===n||null===n)return void Janus.log("Missing sender...");var a=N[n];if(void 0===a||null===a)return void Janus.log("This handle is not attached to this session");a.ondetached(),a.detach()}else{if("error"===e.janus){Janus.log("Ooops: "+e.error.code+" "+e.error.reason);var r=e.transaction;if(null!==r&&void 0!==r){var i=U[r];null!==i&&void 0!==i&&i(e),U[r]=null}return}if("event"===e.janus){var n=e.sender;if(void 0===n||null===n)return void Janus.log("Missing sender...");var s=e.plugindata;if(void 0===s||null===s)return void Janus.log("Missing plugindata...");Janus.log("  -- Event is coming from "+n+" ("+s.plugin+")");var l=s.data;Janus.log(l);var a=N[n];if(void 0===a||null===a)return void Janus.log("This handle is not attached to this session");var c=e.jsep;void 0!==c&&null!==c&&(Janus.log("Handling SDP as well..."),Janus.log(c));var d=a.onmessage;null!==d&&void 0!==d?(Janus.log("Notifying application..."),d(l,c)):Janus.log("No provided notification callback")}else Janus.log("Unknown message '"+e.janus+"'")}}else{var r=e.transaction;if(null!==r&&void 0!==r){var i=U[r];null!==i&&void 0!==i&&i(e),U[r]=null}}}else for(var u=0;u<e.length;u++)t(e[u])}function a(){if(null!==x&&O&&A){setTimeout(a,3e4);var e={janus:"keepalive",session_id:L,transaction:n(12)};M.send(JSON.stringify(e))}}function r(i){var s=n(12),l={janus:"create",transaction:s};return null===x&&$.isArray(I)&&(x=I[R],0===x.indexOf("ws")?(O=!0,Janus.log("Server #"+(R+1)+": trying WebSockets to contact Janus")):(O=!1,Janus.log("Server #"+(R+1)+": trying REST API to contact Janus")),Janus.log(x)),O?(M=new WebSocket(x),M.onerror=function(){return Janus.log("Error connecting to the Janus WebSockets server..."),$.isArray(I)?(R++,R==I.length?void i.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(x=null,void setTimeout(function(){r(i)},200))):void i.error("Error connecting to the Janus WebSockets server: Is the gateway down?")},M.onopen=function(){U[s]=function(e){return Janus.log("Create session:"),Janus.log(e),"success"!==e.janus?(Janus.log("Ooops: "+e.error.code+" "+e.error.reason),void i.error(e.error.reason)):(setTimeout(a,3e4),A=!0,L=e.data.id,Janus.log("Created session: "+L),Janus.sessions[L]=V,void i.success())},M.send(JSON.stringify(l))},M.onmessage=function(e){t(JSON.parse(e.data))},void(M.onclose=function(){null!==x&&A&&(A=!1,e.error("Lost connection to the gateway (is it down?)"))})):void $.ajax({type:"POST",url:x,cache:!1,contentType:"application/json",data:JSON.stringify(l),success:function(e){return Janus.log("Create session:"),Janus.log(e),"success"!==e.janus?(Janus.log("Ooops: "+e.error.code+" "+e.error.reason),void i.error(e.error.reason)):(A=!0,L=e.data.id,Janus.log("Created session: "+L),Janus.sessions[L]=V,o(),void i.success())},error:function(e,n,o){return Janus.log(n+": "+o),$.isArray(I)?(R++,R==I.length?void i.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(x=null,void setTimeout(function(){r(i)},200))):void i.error(""===o?n+": Is the gateway down?":n+": "+o)},dataType:"json"})}function i(o,t){if(t=t===!0,Janus.log("Destroying session "+L+" (sync="+t+")"),o=o||{},o.success="function"==typeof o.success?o.success:jQuery.noop,!A)return Janus.log("Is the gateway down? (connected=false)"),void o.success();if(void 0===L||null===L)return Janus.log("No session to destroy"),o.success(),void e.destroyed();delete Janus.sessions[L];for(ph in N){var a=N[ph];Janus.log("Destroying handle "+a.id+" ("+a.plugin+")"),f(a.id,null,t)}var r={janus:"destroy",transaction:n(12)};return O?(r.session_id=L,M.send(JSON.stringify(r)),o.success(),void e.destroyed()):void $.ajax({type:"POST",url:x+"/"+L,async:t,cache:!1,contentType:"application/json",data:JSON.stringify(r),success:function(n){Janus.log("Destroyed session:"),Janus.log(n),L=null,A=!1,"success"!==n.janus&&Janus.log("Ooops: "+n.error.code+" "+n.error.reason),o.success(),e.destroyed()},error:function(n,t,a){Janus.log(t+": "+a),L=null,A=!1,o.success(),e.destroyed()},dataType:"json"})}function s(e){if(e=e||{},e.success="function"==typeof e.success?e.success:jQuery.noop,e.error="function"==typeof e.error?e.error:jQuery.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:jQuery.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:jQuery.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:jQuery.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:jQuery.noop,e.ondata="function"==typeof e.ondata?e.ondata:jQuery.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:jQuery.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:jQuery.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:jQuery.noop,!A)return Janus.log("Is the gateway down? (connected=false)"),void e.error("Is the gateway down? (connected=false)");var o=e.plugin;if(void 0===o||null===o)return Janus.log("Invalid plugin"),void e.error("Invalid plugin");var t=n(12),a={janus:"attach",plugin:o,transaction:t};return O?(U[t]=function(n){if(Janus.log("Create handle:"),Janus.log(n),"success"!==n.janus)return Janus.log("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var t=n.data.id;Janus.log("Created handle: "+t);var a={session:V,plugin:o,id:t,webrtcStuff:{started:!1,myStream:null,mySdp:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,sdpSent:!1,bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return t},getPlugin:function(){return o},getBitrate:function(){return w(t)},send:function(e){l(t,e)},data:function(e){d(t,e)},dtmf:function(e){u(t,e)},consentDialog:e.consentDialog,onmessage:e.onmessage,createOffer:function(e){p(t,e)},createAnswer:function(e){p(t,e)},handleRemoteJsep:function(e){v(t,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(){S(t)},detach:function(e){f(t,e)}};N[t]=a,e.success(a)},a.session_id=L,void M.send(JSON.stringify(a))):void $.ajax({type:"POST",url:x+"/"+L,cache:!1,contentType:"application/json",data:JSON.stringify(a),success:function(n){if(Janus.log("Create handle:"),Janus.log(n),"success"!==n.janus)return Janus.log("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var t=n.data.id;Janus.log("Created handle: "+t);var a={session:V,plugin:o,id:t,webrtcStuff:{started:!1,myStream:null,mySdp:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,sdpSent:!1,bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return t},getPlugin:function(){return o},getBitrate:function(){return w(t)},send:function(e){l(t,e)},data:function(e){d(t,e)},dtmf:function(e){u(t,e)},consentDialog:e.consentDialog,onmessage:e.onmessage,createOffer:function(e){p(t,e)},createAnswer:function(e){p(t,e)},handleRemoteJsep:function(e){v(t,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(){S(t)},detach:function(e){f(t,e)}};N[t]=a,e.success(a)},error:function(e,n,o){Janus.log(n+": "+o)},dataType:"json"})}function l(e,o){if(o=o||{},o.success="function"==typeof o.success?o.success:jQuery.noop,o.error="function"==typeof o.error?o.error:jQuery.noop,!A)return Janus.log("Is the gateway down? (connected=false)"),void o.error("Is the gateway down? (connected=false)");var t=o.message,a=o.jsep,r={janus:"message",body:t,transaction:n(12)};return null!==a&&void 0!==a&&(r.jsep=a),Janus.log("Sending message to plugin (handle="+e+"):"),Janus.log(r),O?(r.session_id=L,r.handle_id=e,void M.send(JSON.stringify(r))):void $.ajax({type:"POST",url:x+"/"+L+"/"+e,cache:!1,contentType:"application/json",data:JSON.stringify(r),success:function(e){return Janus.log(e),Janus.log("Message sent!"),"ack"!==e.janus?(Janus.log("Ooops: "+e.error.code+" "+e.error.reason),void o.error(e.error.code+" "+e.error.reason)):void o.success()},error:function(e,n,t){Janus.log(n+": "+t),o.error(n+": "+t)},dataType:"json"})}function c(e,o){if(!A)return void Janus.log("Is the gateway down? (connected=false)");var t={janus:"trickle",candidate:o,transaction:n(12)};return Janus.log("Sending trickle candidate (handle="+e+"):"),Janus.log(t),O?(t.session_id=L,t.handle_id=e,void M.send(JSON.stringify(t))):void $.ajax({type:"POST",url:x+"/"+L+"/"+e,cache:!1,contentType:"application/json",data:JSON.stringify(t),success:function(e){return Janus.log(e),Janus.log("Candidate sent!"),"ack"!==e.janus?void Janus.log("Ooops: "+e.error.code+" "+e.error.reason):void 0},error:function(e,n,o){Janus.log(n+": "+o)},dataType:"json"})}function d(e,n){n=n||{},n.success="function"==typeof n.success?n.success:jQuery.noop,n.error="function"==typeof n.error?n.error:jQuery.noop;var o=N[e],t=o.webrtcStuff;if(null===t.dataChannel||void 0===t.dataChannel)return Janus.log("Invalid data channel"),void n.error("Invalid data channel");var a=n.text;return null===a||void 0===a?(Janus.log("Invalid text"),void n.error("Invalid text")):(Janus.log("Sending string on data channel: "+a),t.dataChannel.send(a),void n.success())}function u(e,n){n=n||{},n.success="function"==typeof n.success?n.success:jQuery.noop,n.error="function"==typeof n.error?n.error:jQuery.noop;var o=N[e],t=o.webrtcStuff;if(null===t.dtmfSender||void 0===t.dtmfSender){if(void 0!==t.myStream&&null!==t.myStream){var a=t.myStream.getAudioTracks();if(null!==a&&void 0!==a&&a.length>0){var r=a[0];t.dtmfSender=t.pc.createDTMFSender(r),Janus.log("Created DTMF Sender"),t.dtmfSender.ontonechange=function(e){Janus.log("Sent DTMF tone: "+e.tone)}}}if(null===t.dtmfSender||void 0===t.dtmfSender)return Janus.log("Invalid DTMF configuration"),void n.error("Invalid DTMF configuration")}var i=n.dtmf;if(null===i||void 0===i)return Janus.log("Invalid DTMF parameters"),void n.error("Invalid DTMF parameters");var s=i.tones;if(null===s||void 0===s)return Janus.log("Invalid DTMF string"),void n.error("Invalid DTMF string");var l=i.duration;(null===l||void 0===l)&&(l=500);var c=i.gap;(null===c||void 0===c)&&(c=50),Janus.log("Sending DTMF string "+s+" (duration "+l+"ms, gap "+c+"ms"),t.dtmfSender.insertDTMF(s,l,c)}function f(e,o,t){if(t=t===!0,Janus.log("Destroying handle "+e+" (sync="+t+")"),o=o||{},o.success="function"==typeof o.success?o.success:jQuery.noop,o.error="function"==typeof o.error?o.error:jQuery.noop,S(e),!A)return Janus.log("Is the gateway down? (connected=false)"),void o.error("Is the gateway down? (connected=false)");
var a={janus:"detach",transaction:n(12)};if(O){a.session_id=L,a.handle_id=e,M.send(JSON.stringify(a));{N[e]}return delete N[e],void o.success()}$.ajax({type:"POST",url:x+"/"+L+"/"+e,async:t,cache:!1,contentType:"application/json",data:JSON.stringify(a),success:function(n){Janus.log("Destroyed handle:"),Janus.log(n),"success"!==n.janus&&Janus.log("Ooops: "+n.error.code+" "+n.error.reason);N[e];delete N[e],o.success()},error:function(n,t,a){Janus.log(t+": "+a);N[e];delete N[e],o.success()},dataType:"json"})}function g(e,n,o,t,a){var r=N[e],i=r.webrtcStuff;null!==a&&void 0!==a&&Janus.log(a),i.myStream=a,Janus.log("streamsDone:"),null!==a&&void 0!==a&&Janus.log(a);var s={iceServers:P},l={optional:[{DtlsSrtpKeyAgreement:!0}]};if(Janus.log("Creating PeerConnection:"),Janus.log(l),i.pc=new RTCPeerConnection(s,l),Janus.log(i.pc),i.pc.getStats&&"chrome"==webrtcDetectedBrowser&&(i.bitrate.value="0 kbps"),Janus.log("Preparing local SDP and gathering candidates (trickle="+i.trickle+")"),i.pc.onicecandidate=function(n){null==n.candidate?(Janus.log("End of candidates."),i.iceDone=!0,i.trickle===!0?c(e,null):y(e,t)):(Janus.log("candidates: "+JSON.stringify(n.candidate)),i.trickle===!0&&c(e,n.candidate))},null!==a&&void 0!==a&&(Janus.log("Adding local stream"),i.pc.addStream(a),r.onlocalstream(a)),i.pc.onaddstream=function(e){Janus.log("Handling Remote Stream:"),Janus.log(e),i.pc.getStats&&"chrome"==webrtcDetectedBrowser&&(Janus.log("Starting bitrate monitor"),i.bitrate.timer=setInterval(function(){i.pc.getStats(function(e){for(var n=e.result(),o=0;o<n.length;o++){var t=n[o];if("ssrc"==t.type&&t.stat("googFrameHeightReceived"))if(i.bitrate.bsnow=t.stat("bytesReceived"),i.bitrate.tsnow=t.timestamp,null===i.bitrate.bsbefore||null===i.bitrate.tsbefore)i.bitrate.bsbefore=i.bitrate.bsnow,i.bitrate.tsbefore=i.bitrate.tsnow;else{var a=Math.round(8*(i.bitrate.bsnow-i.bitrate.bsbefore)/(i.bitrate.tsnow-i.bitrate.tsbefore));i.bitrate.value=a+" kbits/sec",i.bitrate.bsbefore=i.bitrate.bsnow,i.bitrate.tsbefore=i.bitrate.tsnow}}})},1e3)),r.onremotestream(e.stream)},j(o)){Janus.log("Creating data channel");var d=function(e){Janus.log("Received message on data channel: "+e.data),r.ondata(e.data)},u=function(){Janus.log("State change on data channel: "+i.dataChannel.readyState),"open"===i.dataChannel.readyState&&r.ondataopen()},f=function(e){Janus.log("Got error on data channel:"),Janus.log(e)};i.dataChannel=i.pc.createDataChannel("JanusDataChannel",{ordered:!1}),i.dataChannel.onmessage=d,i.dataChannel.onopen=u,i.dataChannel.onclose=u,i.dataChannel.onerror=f}null===n||void 0===n?m(e,o,t):i.pc.setRemoteDescription(new RTCSessionDescription(n),function(){Janus.log("Remote description accepted!"),h(e,o,t)},t.error)}function p(e,n){function o(o,t){i.consentDialog(!1),o?n.error(o):g(e,a,r,n,t)}function t(e,n){Janus.log("Adding media constraint (screen capture)"),Janus.log(e),getUserMedia(e,function(e){n(null,e)},function(e){i.consentDialog(!1),n(e)})}n=n||{},n.success="function"==typeof n.success?n.success:jQuery.noop,n.error="function"==typeof n.error?n.error:b;var a=n.jsep,r=n.media,i=N[e],s=i.webrtcStuff;if(void 0!==s.pc&&null!==s.pc)return Janus.log("Updating existing media session"),void(null===a||void 0===a?m(e,r,n):s.pc.setRemoteDescription(new RTCSessionDescription(a),function(){Janus.log("Remote description accepted!"),h(e,r,n)},n.error));if(s.trickle=T(n.trickle),J(r)||k(r)){var l={mandatory:{},optional:[]};i.consentDialog(!0);var c=k(r);if(c===!0&&void 0!=r&&null!=r)if("lowres"===r.video)navigator.mozGetUserMedia?Janus.log("Firefox doesn't support media constraints at the moment, ignoring low-res video"):(c={mandatory:{maxHeight:"240",maxWidth:"320"},optional:[]},Janus.log("Adding media constraint (low-res video)"),Janus.log(c));else if("hires"===r.video)navigator.mozGetUserMedia?Janus.log("Firefox doesn't support media constraints at the moment, ignoring hi-res video"):(c={mandatory:{minHeight:"720",minWidth:"1280"},optional:[]},Janus.log("Adding media constraint (hi-res video)"),Janus.log(c));else if("screen"===r.video){if("https:"!==window.location.protocol)return Janus.log("Screen sharing only works on HTTPS, try the https:// version of this page"),i.consentDialog(!1),void n.error("Screen sharing only works on HTTPS, try the https:// version of this page");var d={};if(window.navigator.userAgent.match("Chrome")){var u=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),f=33;if(window.navigator.userAgent.match("Linux")&&(f=35),u>=26&&f>=u)l={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:3,chromeMediaSource:"screen"}},audio:J(r)},t(l,o);else{var p=window.setTimeout(function(){return y=new Error("NavigatorUserMediaError"),y.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',i.consentDialog(!1),n.error(y)},1e3);d[p]=[o,null],window.postMessage({type:"janusGetScreen",id:p},"*")}}else if(window.navigator.userAgent.match("Firefox")){var v=parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10);if(!(v>=33)){var y=new Error("NavigatorUserMediaError");return y.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",i.consentDialog(!1),void n.error(y)}l={video:{mozMediaSource:"window",mediaSource:"window"},audio:J(r)},t(l,function(e,n){if(o(e,n),!e)var t=n.currentTime,a=window.setInterval(function(){n||window.clearInterval(a),n.currentTime==t&&(window.clearInterval(a),n.onended&&n.onended()),t=n.currentTime},500)})}window.addEventListener("message",function(e){if(e.origin==window.location.origin)if("janusGotScreen"==e.data.type&&d[e.data.id]){var o=d[e.data.id],a=o[0];if(delete d[e.data.id],""===e.data.sourceId){var s=new Error("NavigatorUserMediaError");s.name="You cancelled the request for permission, giving up...",i.consentDialog(!1),n.error(s)}else l={audio:J(r),video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:3},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}},l.video.mandatory.chromeMediaSourceId=e.data.sourceId,t(l,a)}else"janusGetScreenPending"==e.data.type&&window.clearTimeout(e.data.id)})}"screen"!==r.video&&getUserMedia({audio:J(r),video:c},function(o){i.consentDialog(!1),g(e,a,r,n,o)},function(e){i.consentDialog(!1),n.error(e)})}else g(e,a,r,n)}function v(e,n){n=n||{},n.success="function"==typeof n.success?n.success:jQuery.noop,n.error="function"==typeof n.error?n.error:b;var o=n.jsep,t=N[e],a=t.webrtcStuff;if(void 0!==o&&null!==o){if(null===a.pc)return Janus.log("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void n.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");a.pc.setRemoteDescription(new RTCSessionDescription(o),function(){Janus.log("Remote description accepted!"),n.success()},n.error)}else n.error("Invalid JSEP")}function m(e,n,o){o=o||{},o.success="function"==typeof o.success?o.success:jQuery.noop,o.error="function"==typeof o.error?o.error:jQuery.noop;var t=N[e],a=t.webrtcStuff;Janus.log("Creating offer (iceDone="+a.iceDone+")");var r={mandatory:{OfferToReceiveAudio:C(n),OfferToReceiveVideo:D(n)}};Janus.log(r),a.pc.createOffer(function(e){return Janus.log(e),(null===a.mySdp||void 0===a.mySdp)&&(Janus.log("Setting local description"),a.mySdp=e.sdp,a.pc.setLocalDescription(e)),a.iceDone||a.trickle?a.sdpSent?void Janus.log("Offer already sent, not sending it again"):(Janus.log("Offer ready"),Janus.log(o),a.sdpSent=!0,void o.success(e)):void Janus.log("Waiting for all candidates...")},o.error,r)}function h(e,n,o){o=o||{},o.success="function"==typeof o.success?o.success:jQuery.noop,o.error="function"==typeof o.error?o.error:jQuery.noop;var t=N[e],a=t.webrtcStuff;Janus.log("Creating answer (iceDone="+a.iceDone+")");var r={mandatory:{OfferToReceiveAudio:C(n),OfferToReceiveVideo:D(n)}};Janus.log(r),a.pc.createAnswer(function(e){return Janus.log(e),(null===a.mySdp||void 0===a.mySdp)&&(Janus.log("Setting local description"),a.mySdp=e.sdp,a.pc.setLocalDescription(e)),a.iceDone||a.trickle?a.sdpSent?void Janus.log("Answer already sent, not sending it again"):(a.sdpSent=!0,void o.success(e)):void Janus.log("Waiting for all candidates...")},o.error,r)}function y(e,n){n=n||{},n.success="function"==typeof n.success?n.success:jQuery.noop,n.error="function"==typeof n.error?n.error:jQuery.noop;var o=N[e],t=o.webrtcStuff;return Janus.log("Sending offer/answer SDP..."),null===t.mySdp||void 0===t.mySdp?void Janus.log("Local SDP instance is invalid, not sending anything..."):(t.mySdp=t.pc.localDescription,t.sdpSent?void Janus.log("Offer/Answer SDP already sent, not sending it again"):(Janus.log(n),t.sdpSent=!0,void n.success(t.mySdp)))}function w(e){var n=N[e],o=n.webrtcStuff;return void 0===o.bitrate.value||null===o.bitrate.value?"Feature unsupported by browser":o.bitrate.value}function b(e){Janus.log("WebRTC error:"),Janus.log(e)}function S(e){Janus.log("Cleaning WebRTC stuff");var n=N[e],o=n.webrtcStuff;o.bitrate.timer&&clearInterval(o.bitrate.timer),o.bitrate.timer=null,o.bitrate.bsnow=null,o.bitrate.bsbefore=null,o.bitrate.tsnow=null,o.bitrate.tsbefore=null,o.bitrate.value=null,null!==o.myStream&&void 0!==o.myStream&&(Janus.log("Stopping local stream"),o.myStream.stop()),o.myStream=null;try{o.pc.close()}catch(t){}o.pc=null,o.mySdp=null,o.iceDone=!1,o.sdpSent=!1,o.dataChannel=null,o.dtmfSender=null,n.oncleanup()}function J(e){return Janus.log("isAudioSendEnabled:"),Janus.log(e),void 0===e||null===e?!0:e.audio===!1?!1:void 0===e.audioSend||null===e.audioSend?!0:e.audioSend===!0}function C(e){return Janus.log("isAudioRecvEnabled:"),Janus.log(e),void 0===e||null===e?!0:e.audio===!1?!1:void 0===e.audioRecv||null===e.audioRecv?!0:e.audioRecv===!0}function k(e){return Janus.log("isVideoSendEnabled:"),Janus.log(e),void 0===e||null===e?!0:e.video===!1?!1:void 0===e.videoSend||null===e.videoSend?!0:e.videoSend===!0}function D(e){return Janus.log("isVideoRecvEnabled:"),Janus.log(e),void 0===e||null===e?!0:e.video===!1?!1:void 0===e.videoRecv||null===e.videoRecv?!0:e.videoRecv===!0}function j(e){return Janus.log("isDataEnabled:"),Janus.log(e),void 0===e||null===e?!1:e.data===!0}function T(e){return Janus.log("isTrickleEnabled:"),Janus.log(e),void 0===e||null===e?!0:e===!0}if(void 0===Janus.initDone)return e.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),e=e||{},e.success="function"==typeof e.success?e.success:jQuery.noop,e.error="function"==typeof e.error?e.error:jQuery.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:jQuery.noop,null===e.server||void 0===e.server)return e.error("Invalid gateway url"),{};var O=!1,M=null,I=null,R=0,x=e.server;$.isArray(x)?(Janus.log("Multiple servers provided ("+x.length+"), will use the first that works"),x=null,I=e.server,Janus.log(I)):(0===x.indexOf("ws")?(O=!0,Janus.log("Using WebSockets to contact Janus")):(O=!1,Janus.log("Using REST API to contact Janus")),Janus.log(x));var P=e.iceServers;(void 0===P||null===P)&&(P=[{url:"stun:stun.l.google.com:19302"}]);var E=null;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(E=e.max_poll_events),1>E&&(E=1);var A=!1,L=null,N={},V=this,Q=0,U={};r(e),this.getServer=function(){return x},this.isConnected=function(){return A},this.getSessionId=function(){return L},this.destroy=function(e){i(e)},this.attach=function(e){s(e)}}$(document).ready(function(){var e=null,n=null,o=null,t=null,a=null,r=null,i=null,s=function(n){e?e.leave(l,n):c(n)},l=function(e){console.log("cleaning up"),n=null,o=null,t=null,a=null,r=null,i=null,c(e)},c=function(s){"lobby"===s?(console.log("observer calls lobby"),e=null):"hallway"===s?(n=new Hallway,e=n):"lavatory"===s?(o=new Lavatory,e=o):"conference"===s?(t=new Conference,e=t):"lounge"===s?(a=new Lounge,e=a):"stage"===s?(r=new Stage,e=r):"modular"===s?(i=new Modular,e=i):(console.log("start: unrecognized command"),e=null)},d=new Lobby(s),u=function(){var e=window.location.pathname.substring(1),n=window.location.hash.substring(1),o="";switch(o=e?e:n,console.log("urlpath",e),console.log("hashurl",n),console.log("url",o),o){case"hallway":d.hallway();break;case"lavatory":d.lavatory();break;case"stage":d.stage();break;case"modular":d.modular();break;case"conference":d.conference();break;case"lounge":d.lounge();break;default:d.lobby()}};$(window).bind("hashchange",u).trigger("hashchange"),$("#href-lobby").on("click",function(e){window.history.replaceState({},"OpenStream - Lobby","/"),u(e)}),$("#href-hallway").on("click",function(e){window.history.replaceState({},"OpenStream - Hallway","/hallway"),u(e)}),$("#href-lavatory").on("click",function(e){window.history.replaceState({},"OpenStream - Lavatory","/lavatory"),u(e)}),$("#href-lounge").on("click",function(e){window.history.replaceState({},"OpenStream - Lounge","/lounge"),u(e)})});var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]),RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),createIceServer=function(e,n,o){var t=null,a=e.split(":");if(0===a[0].indexOf("stun"))t={url:e};else if(0===a[0].indexOf("turn")&&(-1!==e.indexOf("transport=udp")||-1===e.indexOf("?transport"))){var r=e.split("?");t={url:r[0],credential:o,username:n}}return t},attachMediaStream=function(e,n){console.log("Attaching media stream"),e.mozSrcObject=n,e.play()},reattachMediaStream=function(e,n){console.log("Reattaching media stream"),e.mozSrcObject=n.mozSrcObject,e.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),createIceServer=function(e,n,o){var t=null,a=e.split(":");if(0===a[0].indexOf("stun"))t={url:e};else if(0===a[0].indexOf("turn"))if(28>webrtcDetectedVersion){var r=e.split("turn:");t={url:"turn:"+n+"@"+r[1],credential:o}}else t={url:e,credential:o,username:n};return t},RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(e,n){"undefined"!=typeof e.srcObject?e.srcObject=n:"undefined"!=typeof e.mozSrcObject?e.mozSrcObject=n:"undefined"!=typeof e.src?e.src=URL.createObjectURL(n):console.log("Error attaching stream to element.")},reattachMediaStream=function(e,n){e.src=n.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable"),Janus.sessions={},Janus.extensionId="hapfgfdkleiggjjpfpenajgdnfckjpaj",Janus.isExtensionEnabled=function(){if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),n=33;return window.navigator.userAgent.match("Linux")&&(n=35),e>=26&&n>=e?!0:$("#janus-extension-installed").length>0}return!0},Janus.noop=function(){},Janus.init=function(e){function n(n){if("jquery.min.js"===n&&window.jQuery)return void e.callback();var o=document.getElementsByTagName("head").item(0),t=document.createElement("script");t.type="text/javascript",t.src=n,t.onload=function(){Janus.log("Library "+n+" loaded"),"jquery.min.js"===n&&e.callback()},o.appendChild(t)}e=e||{},e.callback="function"==typeof e.callback?e.callback:Janus.noop,Janus.initDone===!0?e.callback():(("undefined"==typeof console||"undefined"==typeof console.log)&&(console={log:function(){}}),Janus.log=e.debug===!0?console.log.bind(console):Janus.noop,Janus.log("Initializing library"),Janus.initDone=!0,window.onbeforeunload=function(){Janus.log("Closing window");for(var e in Janus.sessions)Janus.log("Destroying session "+e),Janus.sessions[e].destroy()},n("jquery.min.js"))},Janus.isWebrtcSupported=function(){return null===RTCPeerConnection||null===getUserMedia?!1:!0};